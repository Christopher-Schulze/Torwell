# CR-0002 – Coverage, Benchmarks & Fuzzing Quality Gates

## Kontext
Dieser Change Request fasst die neuen Quality-Gate-Arbeiten zusammen. Ziel: einheitliche Runner für Coverage (Frontend/Rust), Benchmarks (Criterion + Playwright) und Fuzzing (cargo-fuzz) mit dokumentierten Abhängigkeiten und Baselines.

## Coverage
- `scripts/tests/coverage.sh` führt Vitest mit `@vitest/coverage-v8` aus. Aktueller Stand (Frontend): **44.03 % Statements / 24.78 % Branches / 20.30 % Functions / 44.03 % Lines**. Größte Lücken: `lib/api.ts`, mehrere UI-Komponenten (`LogsModal.svelte`, `ResourceDashboard.svelte`).
- Rust-Coverage via `cargo tarpaulin` bricht im Container wegen fehlender `glib-2.0` Entwicklungsbibliothek ab (`pkg-config` findet `glib-2.0.pc` nicht). Workaround: `apt-get install libglib2.0-dev` bzw. PKG_CONFIG_PATH in CI setzen.
- Artefakte liegen unter `coverage/frontend/` (HTML + LCOV). Rust-Ausgabe wird nach Verfügbarkeit in `coverage/rust/` geschrieben.

## Benchmarks
- `scripts/benchmarks/run_all.sh` orchestriert Criterion (`cargo bench --bench bootstrap`) sowie Playwright-Performance (`npm run bench:playwright`).
- Criterion scheitert derzeit ebenfalls am fehlenden `glib-2.0` Paket. Nach Installation der Abhängigkeit `libglib2.0-dev` erneut ausführen; Artefakte werden nach `scripts/benchmarks/artifacts/criterion-estimates.json` kopiert und gegen `scripts/benchmarks/baselines/criterion-bootstrap.json` verifiziert.
- Playwright-Suite startet automatisch `npm run dev` auf Port 4173, misst Navigation-Metriken (FCP, DOMContentLoaded, Load Event) und vergleicht gegen `scripts/benchmarks/baselines/playwright-baseline.json` (Toleranz 20 %). Nightly-Lauf erzeugt `scripts/benchmarks/artifacts/playwright-latest.json` und Reporter-JSON.
- Erstlauf benötigt Chromiums Playwright-Browser (`npx playwright install --with-deps` bei Bedarf).

## Fuzzing
- `scripts/tests/fuzz.sh` prüft Abhängigkeiten (`cargo-fuzz`, `rustup toolchain install nightly`) und führt Targets `secure_http_headers` & `bridge_presets` mit `cargo +nightly fuzz run …` aus. `FUZZ_TIME` steuert die Dauer (Default 45 s).
- Erstkompilierung dauert wegen AddressSanitizer/LLVM erheblich (>5 min). Folge-Läufe sind inkrementell schneller.
- Fuzz-Targets liegen in `src-tauri/fuzz/fuzz_targets/`; sie nutzen `torwell84::fuzz_parse_max_age`, `torwell84::fuzz_tls_version` (via `cfg(fuzzing)`), sowie `load_bridge_presets_from_str`.

## Offene Punkte / ToDos
- `glib-2.0` als Systemabhängigkeit in Devcontainer/CI installieren, damit `cargo test`, `cargo tarpaulin` und `cargo bench` fehlerfrei laufen.
- Frontend-Testabdeckung gezielt erhöhen (z. B. `LogsModal.svelte`, `ResourceDashboard.svelte`, Stores).
- Benchmark-Baselines nach erfolgreichem Lauf mit realen Werten aktualisieren (`criterion-bootstrap.json`, `playwright-baseline.json`).
- Geplante Fuzz-Laufzeiten & CI-Integration definieren (z. B. Nightly-Job mit 60 s Timeout, Artefaktaufbewahrung).
